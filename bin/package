#!/bin/bash

set -e
PKG_NAME=bamboo
PKG_HOME=$(readlink -f $(dirname $(readlink -f "$0")))/..
SBT="sbt"

function usage {
  echo "usage: $0 [ --clean ]"
  exit 1
}

while [[ $# -gt 0 ]]
do
  if [[ "$1" == "--clean" ]]
  then
    $SBT clean
  else
    usage
  fi
  shift
done

cd "$PKG_HOME"
bin/setup-remotes

R -e 'rscala::scalaSBT()'

cd "$PKG_HOME/R"
R CMD build --resave-data="best" bamboo

MAJOR=$(cat ../build.sbt | grep "version := " | cut -d '"' -f 2 | cut -d '-' -f 1)

TGZ_NAME=${PKG_NAME}_$MAJOR.tar.gz
echo $TGZ_NAME
cp $TGZ_NAME ../deliveries

R CMD INSTALL $TGZ_NAME
R CMD check --as-cran --run-dontrun --run-donttest $TGZ_NAME

cd ..

rsync --chmod=644 deliveries/$TGZ_NAME dahl.byu.edu:public
ssh dahl.byu.edu "cd public && ln -f -s $TGZ_NAME bamboo_LATEST.tar.gz"
echo -e "####\nPosted to\n  https://dahl.byu.edu/public/$TGZ_NAME\n####"

